:imagesdir: ../assets/images
= Building a secure service network with Red Hat Service Interconnect - Instructions

++++
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-X0GBQ47NJJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-X0GBQ47NJJ');
</script>

<style>
  .underline {
    cursor: pointer;
  }

  .nav-container {
    display: none !important;
  }

  .doc {    
    max-width: 70rem !important;
  }

  .pagination .prev {
    display: none !important;
  }
</style>
++++

:icons: font 
:sectnums:


In this lab, you will use two OpenShift namespaces. In one namespace the Globex application is deployed. The other namespace is isolated from the rest of the cluster through a network policy (only egress allowed, no ingress) and that is where the Globex retail database is deployed. In the lab, you will create a service network between these two clusters, so that the Globex application can connect and use the database in the isolated namespace. 

image::skupper/isolated-env.png[width=70%]

NOTE: The database is not exposed to the outside world. It cannot be reached from other namespaces in the OpenShift cluster.


== Prepare your Development environment
=== Ensure lab readiness

[IMPORTANT]
=====
Before you proceed it is critical that your lab environment is completely ready before executing the lab instructions.
=====

* Access the *Workshop Deployer* browser tab and check if the *Launch new channels using Contract-First approach* card has turned green. This indicates that the module has been fully deployed and is ready to use. 

.Module Readiness on Workshop Deployer
image::skupper/skupper-workshop-deployer.png[width=40%]


== Deployment overview: Globex Web App namespace

. Navigate to the {openshift_cluster_console}[OpenShift console, window="console"],and if needed, login with your username and password *({user_name}/{user_password})*. +
If this is the first time you open the console, you will be directed to the Developer Perspective of the console, which shows you the different namespaces you have access to. 
+
image::skupper/openshift-console-namespaces.png[]

. Click on the `globex-skupper-{user_name}` link to select the namespace you are going to use in this lab, and select `Topology` from the left menu.
+
image::skupper/openshift-console-topology-skupper.png[]

. Expect to see two deployments: The Globex retail application frontend (called *globex-web*, and running on Node.js) and the Globex retail application itself, called *globex-store-app*. Note that the Globex retail application is scaled down to zero pods. As the database is missing, the application would not start up correctly if scaled up. You will scale it up once the connection with the database running in the isolated namespace is established.

. You can check the state of the application by clicking on the image:openshift-console-open-url.png[] icon next to the Node.js deployment.
+
image::skupper/openshift-console-open-url-5.png[]

. This opens a new browser tab pointing to the home page of the Globex retail application.
+
image::skupper/globex-home-page-skupper.png[]

. Click on the *Cool Stuff Store* link in the top menu. This opens a view of the Globex store catalog. If the application would run as expected, you should see a paginated listing of products. However in this case, you will see an empty list:
+
image::skupper/globex-catalog-empty.png[]

== Deployment overview: Globex database namespace

* In the Topology view, select the `globex-skupper-db-{user_name}` namespace from the drop down box at the top. 
+
image::skupper/openshift-console-topology-skupper-isolated-ns.png[]

* Expect to see the deployment for the Globex retail app database.

* The `globex-skupper-db-{user_name}` namespace is isolated from other namespaces and the outside world by applying a Network Policy. To view the Network Policy:
** In the Developer Perspective of the OpenShift console, select *Project* from the menu on the left, and on the project overview page, select the *Details tab*. Click on the *NetworkPolicies* link to view the Network Policies installed in this namespace.
+
image::skupper/openshift-console-project-networkpolicies.png[]
** The Network Policy overview page shows one Network Policy, named *allow-same-namespace*. Click on the name of the Network Policy to open the details page. Scroll down to see the rules defined for ingress traffic:
+
image::skupper/network-policy-ingress-rules.png[]
** The rule defines a whitelist for all pods within the `globex-skupper-db-{user_name}` namespace, blocking all other ingress traffic into the namespace. Thus pods in the `globex-skupper-db-{user_name}` can connect to each other, but connections from outside the namespace will be blocked.

== Activity Overview

Building a Service network between the two namespaces of the OpenShift cluster takes several steps:

* Set up the Service Interconnect *routers* on both the Web App and Database OpenShift namespaces.
* Exchange an *Access Token* created on the Web App namespace where the Globex app is running with the isolated Database namespace.
* This Access Token exchange establishes a *secure link* between the two namespaces. Egress from the Database namespace is allowed, so pods in the namespace can create a connection to other services running in (or outside) the cluster.
* *Validate* that the microservices can use the virtual endpoint service created by the Service Interconnect to access the remote database.